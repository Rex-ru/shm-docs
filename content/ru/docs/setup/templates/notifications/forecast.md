
---
title: "Прогноз оплаты"
weight: 20
---

## Описание

SHM имеет встроенный модуль `forecast`, позволяющий получать информацию о прогнозе оплаты услуг.

`forecast` находит все услуги (кроме уже заблокированных), дата истечения которых менее чем 3 дня (`days`), и ещё неоплаченные услуги, и вычисляет стоимость их продления.


#### Получить прогноз оплаты можно следующими способами:
- Через Web для текущего авторизованного пользователя: `/shm/v1/user/pay/forecast`
- Через Web для пользователя с ID 123: `/shm/v1/user/pay/forecast?user_id=123` (нужно быть авторизованным под администратором)
- Из шаблонов: `user.pays.forecast`

#### Настройки

| Параметр | Описание |
|:---------|----------|
| days     | Кол-во дней для прогноза (`3` дня по-умолчанию)
| blocked  | Учитывать заблокированные услуги (`0` - по-умолчанию НЕТ)

#### Пример команды в шаблонах:

`{{ forecast = user.pays.forecast('days', 10, 'blocked', 1) }}`


## Пример шаблона
Метод `user.pays.forecast` возвращает JSON вида:

```go
{
  "items": [
    {
      "name": "Тариф хостинга",
      "expire": "2017-01-31 23:59:50",
      "total": 123.45,
    },
    {
      "name": "Регистрация домена в зоне .RU: domain.ru",
      "expire": "2017-07-29 12:39:46",
      "total": 590,
    }
  ],
  "dept": 21.56,
  "total": 713.45
}
```

Мы можем построить шаблон письма о прогнозе опаты услуг следующим образом:
```go
Уважаемый {{ user.full_name }}

Уведомляем Вас о сроках действия услуг:

{{ FOR item IN user.pays.forecast.items }}
- Услуга: {{ item.name }}
  Стоимость: {{ item.total }}
  {{ IF item.expire }}
  Истекает: {{ item.expire }}
  {{ END }}
{{ END }}

{{ IF user.pays.forecast.dept }}
Погашение задолженности: {{ user.pays.forecast.dept }}
{{ END }}

Итого к оплате: {{ user.pays.forecast.total }} руб.
```

Подробнее о создании и настройке шаблонов можно прочитать [здесь]({{< ref "/docs/setup/templates" >}})

